<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recepten Ingrediënten Selector</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <div class="container">
        <!-- Link to main recipe page -->
        <div class="main-link-container">
            <a href="{{ url_for('recipe_manager') }}" class="main-link">Naar receptenbeheer</a>
        </div>

        <h1>Selecteer recepten</h1>

        <!-- Recipe buttons container -->
        <div class="recipe-buttons-container">
            {% for recipe in recipes %}
            <button class="recipe-button" data-recipe-id="{{ recipe.id }}" data-recipe-name="{{ recipe.name }}">
                {{ recipe.name }}
            </button>
            {% endfor %}
        </div>

        <!-- Ingredients text area -->
        <div class="ingredients-section">
            <div class="ingredients-container" id="verse-groenten-fruit-ingredients-container">
                <div class="ingredients-header">
                    <h3>Verse groenten en fruit</h3>
                </div>
                <div id="ingredients-chips-verse-groenten-fruit" class="ingredients-chips-container">
                    <div class="empty-state" id="empty-state-verse-groenten-fruit">Geen ingrediënten in deze categorie.</div>
                </div>
            </div>

            <div class="ingredients-container" id="vlees-vis-ingredients-container">
                <div class="ingredients-header">
                    <h3>Vlees en vis</h3>
                </div>
                <div id="ingredients-chips-vlees-vis" class="ingredients-chips-container">
                    <div class="empty-state" id="empty-state-vlees-vis">Geen ingrediënten in deze categorie.</div>
                </div>
            </div>

            <div class="ingredients-container" id="zuivel-ingredients-container">
                <div class="ingredients-header">
                    <h3>Zuivel</h3>
                </div>
                <div id="ingredients-chips-zuivel" class="ingredients-chips-container">
                    <div class="empty-state" id="empty-state-zuivel">Geen ingrediënten in deze categorie.</div>
                </div>
            </div>

            <div class="ingredients-container" id="brood-bakkerij-ingredients-container">
                <div class="ingredients-header">
                    <h3>Brood en bakkerij</h3>
                </div>
                <div id="ingredients-chips-brood-bakkerij" class="ingredients-chips-container">
                    <div class="empty-state" id="empty-state-brood-bakkerij">Geen ingrediënten in deze categorie.</div>
                </div>
            </div>

            <div class="ingredients-container" id="diepvries-ingredients-container">
                <div class="ingredients-header">
                    <h3>Diepvries</h3>
                </div>
                <div id="ingredients-chips-diepvries" class="ingredients-chips-container">
                    <div class="empty-state" id="empty-state-diepvries">Geen ingrediënten in deze categorie.</div>
                </div>
            </div>

            <div class="ingredients-container" id="conserven-ingredients-container">
                <div class="ingredients-header">
                    <h3>Conserven</h3>
                </div>
                <div id="ingredients-chips-conserven" class="ingredients-chips-container">
                    <div class="empty-state" id="empty-state-conserven">Geen ingrediënten in deze categorie.</div>
                </div>
            </div>

            <div class="ingredients-container" id="droge-waren-ingredients-container">
                <div class="ingredients-header">
                    <h3>Droge waren</h3>
                </div>
                <div id="ingredients-chips-droge-waren" class="ingredients-chips-container">
                    <div class="empty-state" id="empty-state-droge-waren">Geen ingrediënten in deze categorie.</div>
                </div>
            </div>

            <div class="ingredients-container" id="dranken-ingredients-container">
                <div class="ingredients-header">
                    <h3>Dranken</h3>
                </div>
                <div id="ingredients-chips-dranken" class="ingredients-chips-container">
                    <div class="empty-state" id="empty-state-dranken">Geen ingrediënten in deze categorie.</div>
                </div>
            </div>

            <div class="ingredients-container" id="snacks-ingredients-container">
                <div class="ingredients-header">
                    <h3>Snacks</h3>
                </div>
                <div id="ingredients-chips-snacks" class="ingredients-chips-container">
                    <div class="empty-state" id="empty-state-snacks">Geen ingrediënten in deze categorie.</div>
                </div>
            </div>

            <div class="ingredients-container" id="ontbijt-ingredients-container">
                <div class="ingredients-header">
                    <h3>Ontbijt</h3>
                </div>
                <div id="ingredients-chips-ontbijt" class="ingredients-chips-container">
                    <div class="empty-state" id="empty-state-ontbijt">Geen ingrediënten in deze categorie.</div>
                </div>
            </div>

            <div class="ingredients-container" id="broodbeleg-ingredients-container">
                <div class="ingredients-header">
                    <h3>Broodbeleg</h3>
                </div>
                <div id="ingredients-chips-broodbeleg" class="ingredients-chips-container">
                    <div class="empty-state" id="empty-state-broodbeleg">Geen ingrediënten in deze categorie.</div>
                </div>
            </div>

            <div class="ingredients-container" id="baby-ingredients-container">
                <div class="ingredients-header">
                    <h3>Baby</h3>
                </div>
                <div id="ingredients-chips-baby" class="ingredients-chips-container">
                    <div class="empty-state" id="empty-state-baby">Geen ingrediënten in deze categorie.</div>
                </div>
            </div>

            <div class="ingredients-container" id="kruiden-ingredients-container">
                <div class="ingredients-header">
                    <h3>Kruiden</h3>
                </div>
                <div id="ingredients-chips-kruiden" class="ingredients-chips-container">
                    <div class="empty-state" id="empty-state-kruiden">Geen ingrediënten in deze categorie.</div>
                </div>
            </div>

            <div class="ingredients-container" id="non-food-ingredients-container">
                <div class="ingredients-header">
                    <h3>Non-food</h3>
                </div>
                <div id="ingredients-chips-non-food" class="ingredients-chips-container">
                    <div class="empty-state" id="empty-state-non-food">Geen ingrediënten in deze categorie.</div>
                </div>
            </div>

            <div class="ingredients-container" id="overig-ingredients-container">
                <div class="ingredients-header">
                    <h3>Overig</h3>
                </div>
                <div id="ingredients-chips-overig" class="ingredients-chips-container">
                    <div class="empty-state" id="empty-state-overig">Selecteer recepten om ingrediënten te zien...</div>
                </div>
            </div>

            <div class="ingredients-actions">
                <button id="copy-button" class="copy-button">Kopieer Ingrediënten (Overig)</button>
                <button id="clear-all-button" class="clear-all-button">Wis Alles</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const recipeButtons = document.querySelectorAll('.recipe-button');
        // Update to select the new general ingredients container and its empty state
        const ingredientsChipsGeneral = document.getElementById('ingredients-chips-overig');
        const emptyStateGeneral = document.getElementById('empty-state-overig');
        
        // Store all chips containers and empty states for easier management
        const allIngredientsContainers = {
            'verse-groenten-fruit': { chips: document.getElementById('ingredients-chips-verse-groenten-fruit'), emptyState: document.getElementById('empty-state-verse-groenten-fruit') },
            'vlees-vis': { chips: document.getElementById('ingredients-chips-vlees-vis'), emptyState: document.getElementById('empty-state-vlees-vis') },
            'zuivel': { chips: document.getElementById('ingredients-chips-zuivel'), emptyState: document.getElementById('empty-state-zuivel') },
            'brood-bakkerij': { chips: document.getElementById('ingredients-chips-brood-bakkerij'), emptyState: document.getElementById('empty-state-brood-bakkerij') },
            'diepvries': { chips: document.getElementById('ingredients-chips-diepvries'), emptyState: document.getElementById('empty-state-diepvries') },
            'conserven': { chips: document.getElementById('ingredients-chips-conserven'), emptyState: document.getElementById('empty-state-conserven') },
            'droge-waren': { chips: document.getElementById('ingredients-chips-droge-waren'), emptyState: document.getElementById('empty-state-droge-waren') },
            'dranken': { chips: document.getElementById('ingredients-chips-dranken'), emptyState: document.getElementById('empty-state-dranken') },
            'snacks': { chips: document.getElementById('ingredients-chips-snacks'), emptyState: document.getElementById('empty-state-snacks') },
            'ontbijt': { chips: document.getElementById('ingredients-chips-ontbijt'), emptyState: document.getElementById('empty-state-ontbijt') },
            'broodbeleg': { chips: document.getElementById('ingredients-chips-broodbeleg'), emptyState: document.getElementById('empty-state-broodbeleg') },
            'baby': { chips: document.getElementById('ingredients-chips-baby'), emptyState: document.getElementById('empty-state-baby') },
            'kruiden': { chips: document.getElementById('ingredients-chips-kruiden'), emptyState: document.getElementById('empty-state-kruiden') },
            'non-food': { chips: document.getElementById('ingredients-chips-non-food'), emptyState: document.getElementById('empty-state-non-food') },
            'overig': { chips: ingredientsChipsGeneral, emptyState: emptyStateGeneral }
        };

        const copyButton = document.getElementById('copy-button');
        const clearAllButton = document.getElementById('clear-all-button');
        let selectedRecipes = new Set();
        let currentIngredients = new Set(); // Still track all unique ingredients globally for now

        // Generate random gradient colors for buttons
        function getRandomGradient() {
            const colors = [
                '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEEAD',
                '#D4A5A5', '#9B59B6', '#3498DB', '#E67E22', '#2ECC71'
            ];
            const color1 = colors[Math.floor(Math.random() * colors.length)];
            const color2 = colors[Math.floor(Math.random() * colors.length)];
            return `linear-gradient(45deg, ${color1}, ${color2})`;
        }

        // Apply random gradients to buttons
        recipeButtons.forEach(button => {
            button.style.background = getRandomGradient();
        });

        // Create ingredient chip
        function createIngredientChip(ingredient) {
            const chip = document.createElement('div');
            chip.className = 'ingredient-chip';
            chip.innerHTML = `
                <span class="chip-text">${ingredient}</span>
                <button class="chip-remove" data-ingredient="${ingredient}">×</button>
            `;
            
            // Add remove functionality
            const removeBtn = chip.querySelector('.chip-remove');
            removeBtn.addEventListener('click', function() {
                const ingredientToRemove = this.dataset.ingredient;
                currentIngredients.delete(ingredientToRemove);
                
                // Remove just this chip instead of rebuilding all
                chip.remove();
                
                // Check if we need to show empty state for the general box
                // Later this will need to check the specific box the chip was in
                if (currentIngredients.size === 0) { // This condition might need adjustment based on categorization
                    allIngredientsContainers['overig'].emptyState.style.display = 'block';
                    // allIngredientsContainers['algemeen'].chips.appendChild(allIngredientsContainers['algemeen'].emptyState);
                }
                // We should also call updateIngredientsDisplay to re-evaluate all boxes
                updateIngredientsDisplay();
            });

            return chip;
        }

        // Update ingredients display
        function updateIngredientsDisplay() {
            // Clear all containers first
            for (const category in allIngredientsContainers) {
                const container = allIngredientsContainers[category];
                container.chips.innerHTML = ''; // Clear chips
                container.emptyState.style.display = 'block'; // Show empty state
                container.chips.appendChild(container.emptyState); // Add empty state back
            }
            
            if (currentIngredients.size === 0) {
                // If no ingredients at all, ensure general empty state is prominent (or handle as per new design)
                // The loop above already handles setting empty states for all.
            } else {
                // TODO: Implement logic to categorize ingredients based on their linked category from the database
                // Currently all ingredients go into the 'overig' category - need to fetch ingredient categories 
                // from the backend and distribute chips to their proper category containers
                
                // For now, all ingredients go into the 'overig' category
                const generalContainer = allIngredientsContainers['overig'];
                generalContainer.emptyState.style.display = 'none';
                Array.from(currentIngredients).sort().forEach(ingredient => {
                    const chip = createIngredientChip(ingredient);
                    generalContainer.chips.appendChild(chip);
                });

                // For other categories, ensure their empty state is shown if they have no specific items yet.
                // (This is handled by the initial clear and empty state display in the loop)
            }
        }

        // Toggle button state and update ingredients
        recipeButtons.forEach(button => {
            button.addEventListener('click', async function() {
                const recipeId = parseInt(this.dataset.recipeId); // Convert string to integer
                const recipeName = this.dataset.recipeName;
                
                if (selectedRecipes.has(recipeId)) {
                    // Recipe is being deselected - remove its ingredients
                    selectedRecipes.delete(recipeId);
                    this.classList.remove('selected');
                    
                    // Fetch ingredients for this recipe to remove them
                    try {
                        const response = await fetch('/get_ingredients', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                recipe_ids: [recipeId]
                            })
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        if (data.success === false) {
                            throw new Error(data.error || 'Failed to fetch ingredients');
                        }
                        
                        if (Array.isArray(data.ingredients)) {
                            // Remove these ingredients from current set
                            data.ingredients.forEach(ingredient => {
                                currentIngredients.delete(ingredient.trim());
                            });
                            updateIngredientsDisplay(); // This will now update the overig box
                        }
                    } catch (error) {
                        console.error('Error fetching ingredients for removal:', error);
                    }
                } else {
                    // Recipe is being selected - add its ingredients
                    selectedRecipes.add(recipeId);
                    this.classList.add('selected');
                    
                    // Fetch ingredients for this recipe to add them
                    try {
                        const response = await fetch('/get_ingredients', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                recipe_ids: [recipeId]
                            })
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        if (data.success === false) {
                            throw new Error(data.error || 'Failed to fetch ingredients');
                        }
                        
                        if (Array.isArray(data.ingredients)) {
                            // Add these ingredients to current set
                            data.ingredients.forEach(ingredient => {
                                currentIngredients.add(ingredient.trim());
                            });
                            updateIngredientsDisplay(); // This will now update the overig box
                        } else {
                            // Display error in the overig ingredients box for now
                            allIngredientsContainers['overig'].chips.innerHTML = '<div class="error-message">Error: Unexpected data format</div>';
                        }
                    } catch (error) {
                        console.error('Error fetching ingredients:', error);
                        // Display error in the overig ingredients box for now
                        allIngredientsContainers['overig'].chips.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
                    }
                }
            });
        });

        // Copy button functionality (copies from 'overig' box for now)
        copyButton.addEventListener('click', function() {
            console.log('Copy button clicked');
            
            // Collect ingredients from the "overig" category for now
            const ingredientsToCopy = [];
            const generalChips = allIngredientsContainers['overig'].chips.querySelectorAll('.chip-text');
            generalChips.forEach(chipText => {
                ingredientsToCopy.push(chipText.textContent);
            });

            if (ingredientsToCopy.length === 0) {
                console.log('No ingredients in overig to copy');
                return;
            }
            
            const ingredientsList = ingredientsToCopy.sort().join('\n');
            console.log('Ingredients to copy (overig):', ingredientsList);
            
            // Store the original text
            const originalText = this.textContent;
            console.log('Original button text:', originalText); // Debug log
            
            // Function to show success state
            const showSuccess = () => {
                this.textContent = 'Gekopieerd!';
                this.classList.add('copied');
                console.log('Showing success state'); // Debug log
                setTimeout(() => {
                    this.textContent = originalText;
                    this.classList.remove('copied');
                    console.log('Restored original state'); // Debug log
                }, 2000);
            };
            
            // Try modern clipboard API first
            if (navigator.clipboard && navigator.clipboard.writeText) {
                console.log('Using modern clipboard API'); // Debug log
                navigator.clipboard.writeText(ingredientsList).then(() => {
                    console.log('Modern clipboard API succeeded'); // Debug log
                    showSuccess();
                }).catch((error) => {
                    console.log('Modern clipboard API failed, trying fallback:', error); // Debug log
                    // Fallback method
                    fallbackCopy(ingredientsList, showSuccess);
                });
            } else {
                console.log('Modern clipboard API not available, using fallback'); // Debug log
                // Fallback method
                fallbackCopy(ingredientsList, showSuccess);
            }
        });

        // Fallback copy method
        function fallbackCopy(text, successCallback) {
            try {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                
                if (successful) {
                    console.log('Fallback copy succeeded'); // Debug log
                    successCallback();
                } else {
                    console.log('Fallback copy failed'); // Debug log
                    alert('Kopiëren mislukt. Probeer handmatig te selecteren en kopiëren.');
                }
            } catch (error) {
                console.log('Fallback copy error:', error); // Debug log
                alert('Kopiëren mislukt. Probeer handmatig te selecteren en kopiëren.');
            }
        }

        // Clear all button functionality
        clearAllButton.addEventListener('click', function() {
            selectedRecipes.clear();
            currentIngredients.clear();
            recipeButtons.forEach(button => {
                button.classList.remove('selected');
            });
            updateIngredientsDisplay(); // This will clear all new boxes and show their empty states.
        });

        // Initialize display
        updateIngredientsDisplay();
    });
    </script>
</body>
</html>